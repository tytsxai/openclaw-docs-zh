# OpenClaw 完整修复方案（2026-02-09）

> 适用环境：macOS 本机部署、Telegram 通道、NVIDIA OpenAI 兼容接口
> 目标：命令面干净、回复稳定、UI 泄露修复、截图问题可控

---

## 1. 当前已确认状态

- 网关运行正常（LaunchAgent + RPC probe ok）
- Telegram 通道正常（polling + probe works）
- 命令面已收敛为 11 条核心命令（default=11、zh=11）
- UI 泄露修复代码已加入并通过定向测试
- 截图问题仍与 LaunchAgent 的屏幕采集权限上下文有关

---

## 2. 根因与处理策略

### A) Telegram 命令“污染”

根因：

1. `language_code=zh` 作用域和 default 作用域存在历史覆盖残留。
2. `native=true` 时会自动注册较宽命令集（含不期望命令）。
3. 部分插件会注入额外命令（如 `pair/phone/voice`）。

处理策略：

1. 禁用不需要的插件命令源。
2. 通过 `commands.include` 锁定核心 11 条。
3. 清理 Telegram 作用域覆盖并统一 default/zh。

### B) UI 泄露（回复出现 `[{"type":"text",...}]`）

根因：

模型或中间链路返回了序列化文本块，最终作为普通字符串回传给用户。

处理策略：

1. 在 `sanitizeUserFacingText` 之前做结构化文本提取与还原。
2. 增加嵌套结构回归测试，避免再次泄露到用户界面。

### C) 截图失败

根因：

LaunchAgent 模式下执行 `/usr/sbin/screencapture` 报错：
`could not create image from display`。

验证事实：

1. 同命令在普通终端可成功。
2. 前台 `openclaw gateway run` 场景可成功。
3. LaunchAgent 场景复现失败。

结论：

这是“进程执行上下文 + macOS 屏幕采集权限”问题，不是模型 API 问题。

---

## 3. 已落地配置（建议保持）

```bash
openclaw config set --json commands.include '["help","commands","status","context","whoami","stop","reset","new","think","verbose","model"]'
openclaw config set commands.native true
openclaw config set commands.nativeSkills false
openclaw config set commands.text true
openclaw config set commands.bash false
openclaw config set commands.config false
openclaw config set commands.debug false
openclaw config set commands.restart false

openclaw config set channels.telegram.commands.native true
openclaw config set channels.telegram.commands.nativeSkills false
openclaw config set --json channels.telegram.customCommands '[]'

openclaw config set plugins.entries.device-pair.enabled false
openclaw config set plugins.entries.phone-control.enabled false
openclaw config set plugins.entries.talk-voice.enabled false

openclaw gateway restart
```

---

## 4. 命令面一键校验

```bash
openclaw channels status --probe
curl -s "https://api.telegram.org/bot<TG_TOKEN>/getMyCommands" | jq
curl -s --get "https://api.telegram.org/bot<TG_TOKEN>/getMyCommands" --data-urlencode 'language_code=zh' | jq
```

期望：

- default：11 条
- zh：11 条
- 都为：`help commands status context whoami stop reset new think verbose model`

---

## 5. 截图能力的可用方案

### 方案 A（推荐，稳定）

截图场景时使用前台网关（在已授权终端窗口运行）：

```bash
openclaw gateway stop
openclaw gateway run --bind loopback --port 18789 --force
```

说明：保持该窗口前台运行；截图相关命令会显著稳定。

### 方案 B（保持后台服务）

继续 LaunchAgent 跑网关，仅把截图作为手工操作能力。

```bash
openclaw gateway install --force
openclaw gateway start
```

说明：聊天能力正常，但自动截图可能仍会失败。

---

## 6. UI 泄露修复代码位置

- `openclaw/src/agents/pi-embedded-helpers/errors.ts`
  - 新增：结构化文本泄露识别与提取
  - 接入：`sanitizeUserFacingText` 清洗链路
- `openclaw/src/agents/pi-embedded-helpers.sanitizeuserfacingtext.test.ts`
  - 新增：数组泄露与嵌套泄露回归用例

验证命令：

```bash
cd /Users/xiaomo/Desktop/OpenClaw-部署文档/openclaw
pnpm -s vitest run src/agents/pi-embedded-helpers.sanitizeuserfacingtext.test.ts src/auto-reply/reply/normalize-reply.test.ts
```

---

## 7. 安全与运维建议（必须）

1. Bot Token 与 API Key 曾在会话/历史中暴露，务必立即轮换。
2. 轮换后仅保留新密钥于 `~/.openclaw/openclaw.json`。
3. 每次改配置后固定执行：`openclaw gateway restart`。
4. 每天巡检一次：`openclaw channels status --probe && openclaw health`。

---

## 8. 最终判定标准（Done Definition）

以下同时满足即为“彻底收敛”：

1. Telegram default/zh 命令都为 11 条核心命令。
2. 常规问答无 `[{"type":"text",...}]` 形式泄露。
3. 模型可正常回复，超时时能自动回退。
4. 截图按选定方案可预期（A 稳定自动、B 手工截图）。

